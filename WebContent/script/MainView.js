// Generated by CoffeeScript 1.4.0
(function() {

  define(['jQueryUI', 'Underscore', 'Backbone.localStorage', 'TaskCollection', 'ListView', 'TaskView', 'EditTaskView', 'text!template/MainView.html'], function($, _, Backbone, TaskCollection, ListView, TaskView, EditTaskView, viewTemplate) {
    return Backbone.View.extend({
      template: _.template(viewTemplate),
      events: {
        "click #newTaskBtn": "onNewButtonClicked",
        "click #showAllLink": "onShowAllLinkClicked"
      },
      initialize: function(options) {
        var taskList,
          _this = this;
        Backbone.View.prototype.initialize.apply(this, arguments);
        this.render();
        Backbone.on("UPDATE_LIST", this.onUpdateList, this);
        $('#datePicker').datepicker({
          onSelect: function(dateText, inst) {
            Backbone.trigger("UPDATE_LIST", {
              dateText: dateText,
              date: $('#datePicker').datepicker("getDate")
            });
          },
          onClose: function(dateText, inst) {
            if (!dateText || dateText.length === 0) {
              Backbone.trigger("UPDATE_LIST");
            }
          }
        });
        taskList = new TaskCollection();
        new EditTaskView({
          el: "#dialogContainer",
          collection: taskList
        });
        new ListView({
          el: "#taskListView",
          itemClass: TaskView,
          collection: taskList
        });
        taskList.load();
        Backbone.trigger("UPDATE_LIST");
      },
      render: function(model, value, options) {
        this.$el.html(this.template());
        return this;
      },
      onNewButtonClicked: function() {
        Backbone.trigger("SHOW_TASK_EDITOR");
      },
      onShowAllLinkClicked: function() {
        Backbone.trigger("UPDATE_LIST");
      },
      onUpdateList: function(options) {
        var hasFilter, title;
        hasFilter = false;
        if (options) {
          if (options.tag) {
            title = _.template("Tasks with tag '<%= tag %>'", options);
            hasFilter = true;
          } else if (options.dateText) {
            title = _.template("Tasks created at '<%= dateText %>'", options);
            hasFilter = true;
          }
        }
        if (hasFilter) {
          $('#showAllLink').css("display", "block");
        } else {
          $('#showAllLink').css("display", "none");
          $('#datePicker').val("");
          title = "All Tasks";
        }
        $("#taskListTitle").text(title);
      },
      remove: function() {
        Backbone.off("UPDATE_LIST", this.onUpdateList, this);
        Backbone.View.prototype.remove.call(this);
      }
    });
  });

}).call(this);
